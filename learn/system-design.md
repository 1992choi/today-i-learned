# System Design
- Inflearn > 개발자라면 꼭 알아야할 시스템디자인 완벽가이드

<br><br>

## 개념 정리
### Latency
- 요청(Request)을 보낸 시점부터 응답(Response)을 받기까지 걸리는 시간
- 네트워크 지연, 서버 처리 시간, DB 조회 시간 등 여러 구간의 시간이 합쳐진 값
- 값이 낮을수록 사용자 체감 속도가 빠름

### Throughput
- 단위 시간당 처리할 수 있는 요청(Request)의 양 
- 보통 RPS(Requests Per Second), TPS(Transactions Per Second)로 표현 
- 서버의 CPU, 메모리, 스레드 수, DB 성능 등에 영향을 받음 
- 값이 높을수록 같은 시간에 더 많은 요청을 처리 가능 
- Latency(지연 시간)와는 다른 개념으로, “얼마나 많이 처리하느냐”에 초점이 있음

### 수평확장 vs 수직확장 (Vertical vs Horizontal Scaling)
- 수직 확장(Vertical Scaling)
  - 기존 서버의 CPU, 메모리, 스펙을 업그레이드하는 방식 
  - 구조가 단순하고 관리가 쉽지만, 물리적 한계가 존재하며 비용이 급격히 증가할 수 있음 
  - 서버 1대에 의존하는 구조가 되기 쉬워 SPOF(Single Point Of Failure, 단일 장애 지점)가 발생하기 쉬움 
- 수평 확장(Horizontal Scaling)
  - 동일한 서버를 여러 대로 늘려 부하를 분산하는 방식 
  - 로드 밸런서를 통해 트래픽을 분산하며, 트래픽 증가에 유연하게 대응 가능 
  - 여러 대 중 일부가 장애가 나더라도 전체 서비스가 중단되지 않아 SPOF를 완화할 수 있음
- 비교
  - 수직 확장은 “한 대를 강하게”, 수평 확장은 “여러 대로 나누어” 처리하는 전략이며 고가용성(HA) 관점에서는 일반적으로 수평 확장이 더 유리함

### 로드밸런싱 (Load Balancing)
- 여러 서버에 트래픽을 분산시켜 부하를 고르게 나누는 기술 
- 단일 서버 과부하를 방지하고, 전체 시스템의 Throughput(처리량)을 향상시킴 
- 일부 서버에 장애가 발생해도 다른 서버로 요청을 우회시켜 가용성(Availability)을 높임 
- 대표적인 알고리즘
  - Round Robin
    - 서버에 요청을 순서대로 하나씩 번갈아가며 분배하는 방식으로, 구현이 단순하고 균등 분산에 적합함
  - Least Connections
    - 현재 활성 연결 수가 가장 적은 서버에 요청을 할당하는 방식으로, 실시간 부하 상황을 반영함
  - IP Hash
    - 클라이언트의 IP 값을 해시하여 특정 서버로 고정 매핑하는 방식으로, 세션 유지에 유리함
- 장점
  - 성능 향상
    - 트래픽을 여러 서버에 분산하여 과부하를 줄이고 전체 처리량을 높일 수 있음
  - 고가용성
    - 일부 서버에 장애가 발생해도 다른 서버가 요청을 처리하여 서비스 중단을 최소화함
  - 확장성
    - 서버를 추가하는 것만으로 처리 용량을 유연하게 늘릴 수 있어 트래픽 증가에 대응하기 용이함

### 분산시스템 (Distributed System)
- 여러 대의 서버(노드)가 네트워크를 통해 연결되어 하나의 시스템처럼 동작하는 구조 
- 각 노드는 독립적으로 동작하지만, 협력하여 하나의 서비스나 기능을 제공함 
- 확장성(Scale-out)과 고가용성(HA)을 확보하기 위해 사용됨 
- 장점
  - 확장성
    - 노드를 추가하는 방식으로 시스템 처리 용량을 수평적으로 확장할 수 있어 트래픽 증가에 유연하게 대응 가능함
  - 가용성
    - 일부 노드에 장애가 발생해도 다른 노드가 서비스를 계속 제공하여 전체 시스템 중단을 방지할 수 있음
  - 성능향상
    - 작업을 여러 노드에 분산 처리하여 병렬 수행이 가능하므로 전체 처리 속도와 처리량을 향상시킬 수 있음
- 분산시스템에서의 고려사항
  - 데이터 일관성
    - 여러 노드에 복제된 데이터가 동일한 값을 유지하도록 보장하는 특성
    - 최종적 일관성(Eventual Consistency)
      - 분산 환경에서는 네트워크 지연과 가용성 확보를 위해 모든 노드가 즉시 동일한 값을 가지도록 강제하기 어렵다.
      - 따라서 일시적으로 데이터 차이를 허용하되, 시간이 지나면 결국 모든 노드의 데이터가 동일한 상태로 수렴하도록 하는 모델이 필요하며, 이를 최종적 일관성이라고 한다.
  - 네트워크 지연
    - 노드 간 통신이 네트워크를 통해 이루어지기 때문에 요청과 응답 사이에 발생하는 지연 시간으로, 시스템 성능과 응답 속도에 직접적인 영향을 줌
  - 복잡한 장애처리
    - 일부 노드나 네트워크 구간에서만 장애가 발생하는 부분 장애 상황이 빈번하므로, 이를 전제로 한 장애 감지와 복구 전략이 필요함
    - 하트비트(Heartbeat)
      - 분산 환경에서는 특정 노드가 단순히 느린 것인지, 실제로 장애가 발생한 것인지 구분해야 한다.
      - 이를 위해 각 노드는 주기적으로 자신의 상태를 알리는 신호를 보내며, 이 신호가 일정 시간 동안 감지되지 않으면 장애로 판단한다.
      - 이러한 장애 감지 메커니즘을 하트비트라고 하며, 자동 장애 조치와 서비스 지속성을 위해 필수적인 요소이다.

### CAP 이론 (CAP Theorem)
- 분산시스템에서 Consistency, Availability, Partition Tolerance 세 가지 특성을 동시에 모두 만족할 수 없다는 이론 
- 네트워크 분할(Partition)이 발생한 상황에서는 Consistency와 Availability 중 하나를 선택해야 함 
- 분산 환경에서는 네트워크 장애를 완전히 피할 수 없기 때문에, 실제 설계에서는 P를 전제로 C와 A 중 무엇을 우선할지 결정하는 것이 핵심 
- 특성
  - Consistency 
    - 모든 노드가 동일한 시점에 동일한 데이터를 반환하는 특성 
  - Availability 
    - 일부 노드에 장애가 있어도 시스템이 항상 응답을 반환하는 특성 
  - Partition Tolerance 
    - 노드 간 네트워크가 단절되어도 시스템이 계속 동작할 수 있는 특성
- CAP 조합에 따른 DB 분류 예시
  - CP (Consistency + Partition Tolerance)
    - 네트워크 분할 상황에서도 데이터 일관성을 우선시하며, 대신 일부 요청은 실패할 수 있음 
    - 예시 
      - MongoDB (기본 설정은 CP에 가까움)
  - AP (Availability + Partition Tolerance)
    - 네트워크 분할 상황에서도 항상 응답을 반환하는 것을 우선시하며, 대신 일시적으로 데이터 불일치를 허용함 (최종적 일관성)
    - 예시 
      - Cassandra 
      - DynamoDB 
  - CA (Consistency + Availability)
    - 네트워크 분할이 없다는 전제하에 일관성과 가용성을 모두 만족 
    - 하지만 실제 분산 환경에서는 Partition을 완전히 배제할 수 없기 때문에 이 조합은 단일 노드 시스템에 가까움 
    - 예시 
      - MySQL (단일 인스턴스 기준)
        - Master / Slave(Primary / Replica) 구조로 확장하는 경우 분산 시스템이 되며, 복제 방식에 따라 성향이 달라짐 
        - 비동기 복제(Async Replication)를 사용하는 일반적인 읽기 분산 구조는 Slave 지연을 허용하므로 AP 성향에 가까움 
        - 반대로, 동기화 수준을 높여 일관성을 강하게 보장하는 구성(Semi-sync 등)은 분할 시 쓰기를 제한할 수 있어 CP 성향에 가까워짐
      - PostgreSQL (단일 인스턴스 기준)

### 장애조치 (Failover)
- Failover란?
  - 시스템에서 장애가 발생했을 때, 정상 동작 중인 다른 서버나 노드가 자동으로 역할을 넘겨받아 서비스를 지속하는 메커니즘
- Failover를 대비한 시스템 구조
  - Primary
    - 실제로 트래픽을 처리하거나 쓰기 작업을 담당하는 주 서버로, 장애 발생 시 교체 대상이 되는 노드
  - Secondary
    - Primary의 상태를 대기하며 데이터 동기화 또는 복제를 유지하다가, Primary 장애 시 역할을 승계하는 예비 서버
- Active - Active / Active - Passive
  - Active - Active
    - 여러 노드가 동시에 요청을 처리하는 구조로, 부하 분산과 자원 활용도가 높지만 데이터 정합성 관리가 더 복잡함
  - Active - Passive
    - 한 노드만 실제로 서비스하고, 나머지는 대기 상태로 있다가 장애 시 전환되는 구조로, 구현이 비교적 단순함
- RTO / RPO
  - RTO (Recovery Time Objective)
    - 장애 발생 후 서비스를 복구하는 데 허용 가능한 최대 시간
  - RPO (Recovery Point Objective)
    - 장애 발생 시점 기준으로, 유실을 허용할 수 있는 데이터의 최대 시점 범위
- Health Check
  - 개념
    - 서버나 애플리케이션의 정상 동작 여부를 주기적으로 확인하여 장애를 탐지하는 메커니즘
  - 단순 ping으로만 판단하면 안되는 이유
    - 서버 프로세스는 살아있더라도 DB 연결 실패, 스레드 고갈, 내부 오류 등으로 실제 서비스는 불가능할 수 있으므로, 애플리케이션 레벨의 상태(예: DB 연결, 주요 의존성 상태 등)까지 확인하는 헬스 체크가 필요함

### 정족수 (Quorum)
- 정족수 (Quorum)란?
  - 분산 시스템에서 특정 작업이나 결정을 수행하기 위해 필요한 최소 동의 노드 수를 의미함
  - 클러스터 내 다수 노드의 동의를 기반으로 쓰기 승인, 리더 선출, 장애 판단 등을 수행하는 기준으로 사용됨
- 필요한 이유
  - 데이터 일관성
    - 과반수 이상의 노드가 동일한 데이터를 승인하도록 하여 오래된 데이터나 충돌 데이터를 방지함
  - 장애 대응
    - 일부 노드가 장애를 일으켜도 다수 노드 기준으로 정상 여부를 판단하여 시스템을 안정적으로 유지함
  - 의사 결정
    - 리더 선출이나 설정 변경 등 중요한 작업을 다수결로 결정하여 신뢰성을 확보함
- Split Brain
  - 네트워크 분할 등으로 클러스터가 둘 이상의 그룹으로 나뉘고, 각각이 자신이 정상이라고 판단해 동시에 동작하는 현상
  - 방지하는 방법
    - 홀수 개의 노드 사용
      - 과반수 계산이 명확해져 한쪽 그룹만 정족수를 만족하도록 만들어 Split Brain 가능성을 줄임
    - 쿼럼 기반 의사 결정
      - 과반수 이상 동의를 얻은 그룹만 리더 선출이나 쓰기를 허용하도록 하여 다중 리더 발생을 방지함
- 분산시스템에서의 정족수 사용 예시
  - Apache ZooKeeper
    - 분산 시스템에서 리더 선출, 설정 관리, 분산 락과 같은 조정 작업을 담당하는 시스템
    - 클러스터는 Leader 1대와 여러 Follower로 구성되며, 리더 선출 시 과반수(Quorum) 동의를 받아야 함
    - 과반수를 확보하지 못하면 잘못된 리더 선출을 방지하기 위해 쓰기 작업을 중단함
  - Kafka에서의 ISR
    - 하나의 파티션은 Leader와 여러 Follower로 구성됨
    - ISR(In-Sync Replicas)은 Leader와 동기화가 완료된 복제본들의 집합을 의미함
    - 프로듀서의 acks 설정이 all인 경우, ISR에 포함된 노드까지 데이터가 복제되어야 쓰기 성공으로 처리됨
    - 즉, ISR은 최신 상태를 유지하는 복제 집합을 관리하여 사실상 정족수 기반 안정성을 보장하는 역할을 수행함